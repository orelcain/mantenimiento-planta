rules_version = '2';
// Version: v1.0.6 - Updated: 2025-12-25
// Sistema de jerarquías anidadas de 8 niveles con integración UI
service cloud.firestore {
  match /databases/{database}/documents {
    // Funciones helper
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
    }
    
    function isSupervisor() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol in ['admin', 'supervisor'];
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Validar nivel jerárquico
    function isValidHierarchyLevel(level) {
      return level >= 1 && level <= 8;
    }

    // Validar código de jerarquía
    function isValidHierarchyCode(code) {
      return code is string && code.size() >= 5 && code.size() <= 20;
    }

    // Jerarquías organizacionales (8 niveles)
    match /hierarchy/{nodeId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin()
        && request.resource.data.nombre is string
        && request.resource.data.nombre.size() >= 3
        && request.resource.data.nombre.size() <= 100
        && isValidHierarchyCode(request.resource.data.codigo)
        && isValidHierarchyLevel(request.resource.data.nivel)
        && request.resource.data.path is list
        && request.resource.data.path.size() <= 8
        && request.resource.data.activo is bool;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Usuarios
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // Códigos de invitación
    match /inviteCodes/{codeId} {
      allow read: if true; // Permitir verificar códigos sin auth
      allow create: if isAdmin();
      allow update: if isAuthenticated(); // Para incrementar usos
      allow delete: if isAdmin();
    }

    // Incidencias
    match /incidents/{incidentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated()
        && request.resource.data.titulo is string
        && request.resource.data.titulo.size() >= 5
        && request.resource.data.titulo.size() <= 100
        && request.resource.data.descripcion is string
        && request.resource.data.descripcion.size() >= 10
        && request.resource.data.descripcion.size() <= 1000
        && request.resource.data.prioridad in ['critica', 'alta', 'media', 'baja']
        && request.resource.data.status in ['pendiente', 'confirmada', 'rechazada', 'en_proceso', 'cerrada']
        && request.resource.data.tipo in ['correctivo', 'preventivo', 'predictivo', 'proactivo']
        && request.resource.data.zoneId is string
        && request.resource.data.reportadoPor == request.auth.uid
        && (!('sintomas' in request.resource.data) || request.resource.data.sintomas.size() <= 20)
        && (!('fotos' in request.resource.data) || request.resource.data.fotos.size() <= 10);
      allow update: if isAuthenticated()
        && (
          // Owner can update if status is 'pendiente'
          (resource.data.reportadoPor == request.auth.uid && resource.data.status == 'pendiente')
          // Supervisor/Admin can always update
          || isSupervisor()
        )
        && (!('titulo' in request.resource.data) || (
          request.resource.data.titulo is string
          && request.resource.data.titulo.size() >= 5
          && request.resource.data.titulo.size() <= 100
        ))
        && (!('descripcion' in request.resource.data) || (
          request.resource.data.descripcion is string
          && request.resource.data.descripcion.size() >= 10
          && request.resource.data.descripcion.size() <= 1000
        ))
        && (!('prioridad' in request.resource.data) || (
          request.resource.data.prioridad in ['critica', 'alta', 'media', 'baja']
        ))
        && (!('sintomas' in request.resource.data) || request.resource.data.sintomas.size() <= 20)
        && (!('resolucion' in request.resource.data) || (
          request.resource.data.resolucion.size() >= 20
          && request.resource.data.resolucion.size() <= 1000
        ));
      allow delete: if isAdmin();
    }

    // Zonas
    match /zones/{zoneId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin()
        && request.resource.data.nombre is string
        && request.resource.data.nombre.size() >= 2
        && request.resource.data.nombre.size() <= 100
        && request.resource.data.codigo is string
        && request.resource.data.codigo.size() >= 1
        && request.resource.data.codigo.size() <= 20
        && request.resource.data.nivel in [1, 2, 3]
        && request.resource.data.tipo in ['produccion', 'almacen', 'oficinas', 'mantenimiento', 'carga_descarga', 'servicios', 'seguridad', 'maquina', 'otro']
        && request.resource.data.polygon.size() >= 3;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Equipos
    match /equipment/{equipmentId} {
      allow read: if isAuthenticated();
      allow create: if (isAdmin() || isSupervisor())
        && request.resource.data.codigo is string
        && request.resource.data.codigo.size() >= 1
        && request.resource.data.codigo.size() <= 20
        && request.resource.data.nombre is string
        && request.resource.data.nombre.size() >= 2
        && request.resource.data.nombre.size() <= 100
        && request.resource.data.criticidad in ['alta', 'media', 'baja']
        && request.resource.data.estado in ['operativo', 'en_mantenimiento', 'fuera_servicio']
        && request.resource.data.zoneId is string;
      allow update: if isAuthenticated()
        && (!('nombre' in request.resource.data) || (
          request.resource.data.nombre is string
          && request.resource.data.nombre.size() >= 2
          && request.resource.data.nombre.size() <= 100
        ))
        && (!('criticidad' in request.resource.data) || (
          request.resource.data.criticidad in ['alta', 'media', 'baja']
        ))
        && (!('estado' in request.resource.data) || (
          request.resource.data.estado in ['operativo', 'en_mantenimiento', 'fuera_servicio']
        ));
      allow delete: if isAdmin();
    }

    // Tareas preventivas
    match /preventiveTasks/{taskId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isSupervisor();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Ejecuciones preventivas
    match /preventiveExecutions/{executionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Predicciones de falla
    match /failurePredictions/{predictionId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Análisis de causa raíz
    match /rootCauseAnalysis/{analysisId} {
      allow read: if isAuthenticated();
      allow create: if isSupervisor();
      allow update: if isSupervisor();
      allow delete: if isAdmin();
    }

    // Repuestos
    match /spareParts/{partId} {
      allow read: if isAuthenticated();
      allow create: if isAdmin() || isSupervisor();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }

    // Movimientos de inventario
    match /inventoryMovements/{movementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // Configuración
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
  }
}
